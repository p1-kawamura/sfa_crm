{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'main.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="icon" href="{% static 't-shirt_3.gif' %}">
    <title>定期配信リスト / アプローチリスト</title>
</head>
<body>

    <div class="mt-3 mb-5">

        <!-- メニュー -->
        <div style="margin: 0 auto; width: 1150px">
            {% include "sfa/menu.html" with act_user=act_user %}
        </div>

        <div style="margin: 0 auto; width: 1340px;">
            <hr>
            <div class="block_title">定期配信リスト / アプローチリスト</div>
            <hr>
            <!-- フィルター -->
            <div class="flex3">
                <div class="flex">
                    <div style="font-size: 1.2em;">
                        {% if ses.han_or_apr == "han" %}
                        <input class="form-check-input" type="radio" id="choice_hangire" name="shurui" checked> 通常版切れ
                        {% else %}
                        <input class="form-check-input" type="radio" id="choice_hangire" name="shurui"> 通常版切れ
                        {% endif %}
                    </div>
                    <div style="font-size: 1.2em; margin-left: 50px;">
                        {% if ses.han_or_apr == "half" %}
                        <input class="form-check-input" type="radio" id="choice_half" name="shurui" checked> 半年版切れ
                        {% else %}
                        <input class="form-check-input" type="radio" id="choice_half" name="shurui"> 半年版切れ
                        {% endif %}
                    </div>
                    <div style="font-size: 1.2em; margin-left: 50px;">
                        {% if ses.han_or_apr == "not_han" %}
                        <input class="form-check-input" type="radio" id="choice_igai" name="shurui" checked> 版切れ以外受注
                        {% else %}
                        <input class="form-check-input" type="radio" id="choice_igai" name="shurui"> 版切れ以外受注
                        {% endif %}
                    </div>
                    <div style="font-size: 1.2em; margin-left: 50px;">
                        {% if ses.han_or_apr == "nou" %}
                        <input class="form-check-input" type="radio" id="choice_nouhin" name="shurui" checked> 納品フォロー
                        {% else %}
                        <input class="form-check-input" type="radio" id="choice_nouhin" name="shurui"> 納品フォロー
                        {% endif %}
                    </div>
                    <div style="font-size: 1.2em; margin-left: 50px;">
                        {% if ses.han_or_apr == "lost" %}
                        <input class="form-check-input" type="radio" id="choice_lost" name="shurui" checked> 失注
                        {% else %}
                        <input class="form-check-input" type="radio" id="choice_lost" name="shurui"> 失注
                        {% endif %}
                    </div>
                </div>
                <div>
                    <a href="{% url 'apr:shukei_index' %}" target="_blank"><button class="btn btn-primary"><img src="{% static 'ryouma.gif' %}"> 集計リスト</button></a>
                </div>
            </div>
            <div class="flex" style="margin-top: 20px;">
                <div style="font-size: 1.2em;">
                    {% if ses.han_or_apr == "apr" %}
                    <input class="form-check-input" type="radio" id="choice_approach" name="shurui" checked> アプローチリスト
                    {% else %}
                    <input class="form-check-input" type="radio" id="choice_approach" name="shurui"> アプローチリスト
                    {% endif %}
                </div>
                {% if ses.han_or_apr == "apr" %}
                <div id="choice_approach_select" style="font-size: 1.2em; margin-left: 20px;">
                {% else %}
                <div id="choice_approach_select" style="font-size: 1.2em; margin-left: 20px; display: none;">
                {% endif %}
                    <select class="form-select" id="choice_approach_id" style="width: 500px;">
                        <option value=""></option>
                        {% for i in apr_list reversed %}
                            {% if i.approach_id == ses.approach_id %}
                            <option value="{{i.approach_id}}" selected>{{i.title}}</option>
                            {% else %}
                            <option value="{{i.approach_id}}">{{i.title}}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div style="margin-top: 50px;">
                <form action="{% url 'apr:hangire_search' %}" method="post">{% csrf_token %}
                    <div class="flex mt-4">
                        <div>部署：</div>
                        <div>
                            <select class="form-select" name="han_busho" id="han_busho" style="width: 240px;">
                                <option value=""></option>
                                {% for i in busho_up %}
                                    {% if i.0 == ses.han_busho %}
                                    <option value="{{i.0}}" selected>{{i.1}}</option>
                                    {% else %}
                                    <option value="{{i.0}}">{{i.1}}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div style="margin-left: 30px;">担当者：</div>
                        <div>
                            <select class="form-select" name="han_tantou" id="han_tantou" style="width: 150px;">
                                <option value=""></option>
                                {% for i in tantou_up %}
                                    {% if i.0 == ses.han_tantou %}
                                    <option value="{{i.0}}" selected>{{i.1}}</option>
                                    {% else %}
                                    <option value="{{i.0}}">{{i.1}}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div style="margin-left: 30px;">都道府県：</div>
                        <div>
                            <select class="form-select form-select-sm" id="han_pref" name="han_pref" style="width: 110px;">
                                {% for i in pref_list %}
                                    {% if i == ses.han_pref %}
                                    <option value="{{i}}" selected>{{i}}</option>
                                    {% else %}
                                    <option value="{{i}}">{{i}}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div style="margin-left: 30px;">{{sort_list.juchu_day}}：</div>
                        <div><input class="form-control form-select-sm" type="date" id="han_day_st" name="han_day_st" style="width: 140px;" value="{{ses.han_day_st}}"></div>
                        <div style="margin: 0px 10px;">～</div>
                        <div><input class="form-control form-select-sm" type="date" id="han_day_ed" name="han_day_ed" style="width: 140px;" value="{{ses.han_day_ed}}"></div>
                    </div>
                    <div class="flex mt-4">
                        <div>会社名：</div>
                        <div><input class="form-control form-select-sm" type="text" id="han_com" name="han_com" style="width: 200px;" value="{{ses.han_com}}"></div>
                        <div style="margin-left: 30px;">姓：</div>
                        <div><input class="form-control form-select-sm" type="text" id="han_sei" name="han_sei" style="width: 80px;" value="{{ses.han_sei}}"></div>
                        <div style="margin-left: 30px;">名：</div>
                        <div><input class="form-control form-select-sm" type="text" id="han_mei" name="han_mei" style="width: 80px;" value="{{ses.han_mei}}"></div>
                        <div style="margin-left: 30px;">電話番号 / 携帯番号：</div>
                        <div><input class="form-control form-select-sm" type="text" id="han_tel" name="han_tel" style="width: 140px;" value="{{ses.han_tel}}"></div>
                        <div style="margin-left: 30px;">メールアドレス：</div>
                        <div><input class="form-control form-select-sm" type="text" id="han_mail" name="han_mail" style="width: 300px;" value="{{ses.han_mail}}"></div>
                    </div>
                    <div class="flex mt-4">
                        <div>結果：</div>
                        <div style="margin-left: -20px;" class="flex">
                            {% for i in result_list %}
                                {% if i.0 != "tran" %}
                                    {% if i.0 in ses.han_result %}
                                    <div class="flex" style="margin-left: 20px;">
                                        
                                        <div><input class="form-check-input" type="checkbox" name="han_result" value="{{i.0}}" checked> {{i.1}}</div>
                                        <div id="result_{{i.0}}">（{{i.2}}）</div>
                                    </div>
                                    {% else %}
                                    <div class="flex" style="margin-left: 20px;">
                                        <div><input class="form-check-input" type="checkbox" name="han_result" value="{{i.0}}"> {{i.1}}</div>
                                        <div id="result_{{i.0}}">（{{i.2}}）</div>
                                    </div>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    <div class="flex mt-4">
                        <div><i class="bi bi-arrow-down-up"></i> <b>並び替え：</b></div>
                        <div>
                            <select class="form-select form-select-sm" name="sort_name" style="width: 120px;">
                                {% for key,value in sort_list.items %}
                                    {% if key == ses.sort_name %}
                                    <option value="{{key}}" selected>{{value}}</option>
                                    {% else %}
                                    <option value="{{key}}">{{value}}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div style="margin-left: 10px;">
                            <select class="form-select form-select-sm" name="sort_jun" style="width: 80px;">
                                {% if ses.sort_jun == "0" %}
                                <option value="0" selected>昇順</option>
                                <option value="l">降順</option>
                                {% else %}
                                <option value="0">昇順</option>
                                <option value="l" selected>降順</option>
                                {% endif %}
                            </select>
                        </div>
                        <div style="margin-left: 40px;">
                            <button type="submit" class="btn btn-secondary"><i class="bi bi-search"></i> 検索</button>
                        </div>
                        <div style="margin-left: 30px;">
                            <button class="btn btn-outline-dark" id="form_clear"><i class="bi bi-eraser"></i> 詳細クリア</button>
                        </div>
                    </div>
 
                </form>
            </div>
            <hr>

            <!-- 顧客一覧 -->
            <div class="table_wrap" style="margin-top: 15px; width: 1340px;">

                <table class="table table-bordered table_approach" style="font-size: 0.9em;">
                    <tr>
                        <th></th>
                        <th>結果</th>
                        <th>日付</th>
                        <th>記入者</th>
                        <th>種類</th>
                        <th class="th1">備考</th>
                        <th>{{sort_list.juchu_day}}</th>
                        <th>見積</th>
                        <th>顧客</th>
                        <th>都道府県</th>
                        <th>会社</th>
                        <th>氏名</th>
                        <th>加工方法</th>
                        <th>他①</th>
                        <th>他②</th>
                        <th>他③</th>
                        <th>注文区分</th>
                        <th>合計金額</th>
                        <th>電話 / 携帯</th>
                        <th>メールアドレス</th>
                        <th>顧客詳細</th>
                        <th>担当部署</th>
                        <th>担当者</th>
                        <th>見積部署</th>
                        <th>見積担当者</th>
                    </tr>
                    {% for i in cus_list %}

                    {% if i.pk == pk %}
                    <tr class="hover2" style="background-color: #e0ffc2;">
                        <td>
                            <span style="font-size: 1.2em; cursor: pointer;" id="clear_color" onclick="clear_color()">
                                <i class='bi bi-caret-up-square-fill'></i>
                            </span>
                        </td>
                    {% else %}
                    <tr class="hover2">
                        <td>
                            <span style="font-size: 1.2em; cursor: pointer;" name="open_modal" id="open_{{i.pk}}" data-bs-toggle="modal" data-bs-target="#modal_apr">
                                <i class="bi bi-pencil-square"></i>
                            </span>
                        </td>
                    {% endif %}
                        
                    
                        {% if i.result == "0" %}
                        <td></td>
                        {% elif i.result == "1" %}
                        <td style="background-color: #959595; text-align: center; font-size: 0.9em;"><span style="color: #000;">アプローチしない</span></td>
                        {% elif i.result == "2" %}
                        <td style="background-color: #eedfff; text-align: center; font-size: 0.9em;"><span style="color: #800080;">不在</span></td>
                        {% elif i.result == "3" %}
                        <td style="background-color: #dcffbf; text-align: center; font-size: 0.9em;"><span style="color: #005b00;">検討します</span></td>
                        {% elif i.result == "4" %}
                        <td style="background-color: #e2e2e2; text-align: center; font-size: 0.9em;"><span style="color: #000;">失注/予定なし</span></td>
                        {% elif i.result == "5" %}
                        <td style="background-color: #b7ffff; text-align: center; font-size: 0.9em;"><span style="color: #0000a0;">案件化</span></td>
                        {% elif i.result == "6" %}
                        <td style="background-color: #ffff80; text-align: center; font-size: 0.9em;"><span style="color: #ff0000;">受注</span></td>
                        {% elif i.result == "7" %}
                        <td style="background-color: #ffdddd; text-align: center; font-size: 0.9em;"><span style="color: #000;">その他</span></td>
                        {% endif %}

                        <td>{% if i.apr_day %}{{i.apr_day}}{% endif %}</td>
                        <td>{% if i.apr_tantou %}{{i.apr_tantou}}{% endif %}</td>
                        <td style="text-align: center;">
                            {% if i.apr_type == 4 %}
                                {% if i.apr_tel_result == "対応" %}
                                    <span style="color: blue; font-size: 1.5em;"><i class="bi bi-telephone-forward-fill"></i></span>
                                {% else %}
                                    <span style="color: rgb(130, 130, 130); font-size: 1.5em;"><i class="bi bi-telephone-x-fill"></i></span>
                                {% endif %}
                            {% elif i.apr_type == 2 %}
                                <span style="color: #ff9900; font-size: 1.5em;"><i class="bi bi-envelope-fill"></i></span>
                            {% elif i.apr_type == 1 %}
                                <span style='color: #646565; font-size: 1.2em;'><i class='bi bi-clipboard-fill'></i></span>
                            {% endif %}
                        </td>
                        <td class="bikou">{% if i.apr_text %}{{i.apr_text}}{% endif %}</td>
                        <td>{{i.juchu_day}}</td>
                        <td style="text-align: center;">
                            <a href="{{i.mitsu_url}}" target="_blank"><span style="color: #008b8b; font-size: 1.2em;">
                                <i class="bi bi-box-arrow-up-right"></i></span></a>
                        </td>
                        <td style="text-align: center;">
                            <a href="{{i.cus_url}}" target="_blank"><span style="color: #ee827c; font-size: 1.2em;">
                                <i class="bi bi-box-arrow-up-right"></i></span></a>
                        </td>
                        <td>{% if i.pref %}{{i.pref}}{% endif %}</td>
                        <td>{% if i.cus_com %}{{i.cus_com | truncatechars:14}}{% endif %}</td>
                        <td>{% if i.cus_sei %}{{i.cus_sei}}{% endif %}{% if i.cus_mei %}{{i.cus_mei}}{% endif %}</td>
                        <td>{% if i.kakou %}{{i.kakou}}{% endif %}</td>
                        <td>{% if i.yobi_1 %}{{i.yobi_1}}{% endif %}</td>
                        <td>{% if i.yobi_2 %}{{i.yobi_2}}{% endif %}</td>
                        <td>{% if i.yobi_3 %}{{i.yobi_3}}{% endif %}</td>
                        <td>{{i.order_kubun}}</td>
                        <td style="text-align: right;">{{i.money | intcomma}}</td>
                        <td>{% if i.cus_tel %}{{i.cus_tel}}{% elif i.cus_mob %}{{i.cus_mob}}{% endif %}</td>
                        <td>{{i.cus_mail}}</td>
                        <td style="text-align: center;">
                            <button type="button" class="btn btn-outline-success btn-sm" style="border-radius: 50%;" name="crm_list">
                                <i class="bi bi-person-square"></i>
                                <span style="display: none;" id="apr_cus_{{i.pk}}">{{i.cus_id}}</span>
                            </button>
                        </td>
                        <td>{{i.busho_apr_name}}</td>
                        <td>{{i.tantou_apr_name}}</td>
                        <td>{{i.busho_name}}</td>
                        <td>{{i.tantou_sei}} {{i.tantou_mei}}</td>
                    </tr>
                    {% endfor %}
                </table>
            </div>

            <!-- モーダル -->
            <div class="modal fade" id="modal_apr" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <!-- HEADER -->
                        <div class="modal-header">
                            <div id="exampleModalLabel"></div>
                            <div class="flex">
                                <div id="modal_pk" style="display: none;"></div>
                                <div id="modal_user" style="display: none;">{{modal_user}}</div>
                                <div id="modal_cus_com" style="margin-left: 30px; font-size: 1.2em; font-weight: bold;"></div>
                                <div id="modal_cus_name" style="margin-left: 30px; font-size: 1.2em; font-weight: bold;"></div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" name="modal_btn_close"></button>
                        </div>
                        <!-- BODY -->
                        <div class="modal-body">
                            <div class="flex2">
                                <div id="modal_left"></div>
                                <div style="margin-left: 25px;">
                                    <!-- TOP -->
                                    <div>
                                        <div class="flex3" style="align-items: center;">
                                            <div><button class="btn btn-danger btn-sm" id="modal_result_juchu">受注にする</button></div>
                                            <div style="font-size: 0.9em;">
                                                <button class="btn btn-outline-danger btn-sm" id="modal_result_del">結果をクリア</button>
                                            </div>
                                        </div>
                                        <div style="margin-top: 5px; font-size: 0.9em;">
                                            <table class="table table-bordered">
                                                <tr>
                                                    <th style="width: 100px;" nowrap>最終結果</th>
                                                    <th style="width: 95px;" nowrap>日付</th>
                                                    <th style="width: 70px;" nowrap>記入者</th>
                                                    <th style="width: 50px;" nowrap>種類</th>
                                                    <th nowrap>備考</th>
                                                </tr>
                                                <tr>
                                                    <td id="modal_top_result" style="text-align: center;" nowrap></td>
                                                    <td id="modal_top_day" nowrap></td>
                                                    <td id="modal_top_tantou" nowrap></td>
                                                    <td id="modal_top_type" style="text-align: center;"></td>
                                                    <td id="modal_top_bikou"></td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                    <hr>
                                    <!-- BOT -->
                                    <div style="margin-top: 20px;">
                                        <div class="flex" id="modal_show_A">
                                            <div>■ 結果：</div>
                                            <div>
                                                <select class="form-select form-select-sm" id="modal_apr_result">
                                                    {% for i in result_list %}
                                                    <option value={{i.0}}>{{i.1}}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="flex" id="modal_tantou_block" style="margin-left: 30px;">
                                                <div>記入者：</div>
                                                <div><input class="form-control form-control-sm" type="text" id="modal_apr_tantou" style="width: 80px;"></div>
                                            </div>
                                        </div>

                                        <!-- 通常入力 -->
                                        <div id="modal_show_B">
                                            <div class="flex mt-3">
                                                <div>種類：</div>
                                                <div>
                                                    <select class="form-select form-select-sm" id="modal_apr_type">
                                                        {% for i,h in apr_type_list.items %}
                                                        <option value="{{i}}">{{h}}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div id="modal_tel_hyouji" style="display: none;">
                                                    <select class="form-select form-select-sm" id="modal_apr_tel">
                                                        <option value="対応">対応</option>
                                                        <option value="不在">不在</option>
                                                    </select>
                                                </div>
                                                <div style="margin-left: 20px;">日付：</div>
                                                <div><input class="form-control form-control-sm" type="date" id="modal_apr_day" style="width: 120px;"></div>
                                                <div style="margin-left: 20px;"><button class="btn btn-outline-dark btn-sm" id="modal_btn_apr_new">新規</button></div>
                                                <div style="margin-left: 20px;"><button class="btn btn-outline-danger btn-sm" id="modal_btn_apr_del">削除</button></div>
                                                <div id="modal_act_id" style="display: none;"></div>
                                            </div>
                                            <div class="flex">
                                                <div style="margin-top: 10px; width: 620px;">
                                                    <textarea class="form-control" rows="2" id="modal_apr_text" maxlength="255" placeholder="最大255文字"></textarea>
                                                </div>
                                                <div style="margin-left: 20px;"><button class="btn btn-primary btn-sm" id="modal_btn_apr_ok">決定</button></div>
                                            </div>
                                        </div>

                                        <!-- 他拠点へ転送 -->
                                        <div class="flex mt-3 mb-5" id="modal_show_C" style="display: none;">
                                            <div>部署：</div>
                                            <div>
                                                <select class="form-select form-select-sm" id="modal_send_busho" style="width: 120px;">
                                                    <option value="0"></option>
                                                    {% for i in busho_now %}
                                                        <option value="{{i.0}}">{{i.1}}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div style="margin-left: 30px;">担当者：</div>
                                            <div>
                                                <select class="form-select form-select-sm" id="modal_send_tantou" style="width: 120px;">
                                                    <option value="0"></option>
                                                    {% for i in tantou_now %}
                                                        <option value="{{i.0}}">{{i.1}}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div style="margin-left: 30px;">
                                                <button type="button" class="btn btn-secondary btn-sm" id="modal_send_click">転送</button>                                    
                                            </div>
                                        </div>

                                        <!-- 履歴一覧 -->
                                        <div style="width: 75px; margin-top: 10px;">
                                            <select class="form-select form-select-sm" id="modal_sort">
                                                {% if modal_sort == "0" %}
                                                <option value="0" selected>昇順</option>
                                                <option value="1">降順</option>
                                                {% else %}
                                                <option value="0">昇順</option>
                                                <option value="1" selected>降順</option>
                                                {% endif %}
                                            </select>
                                        </div>
                                        <div class="inlineframe3" id="modal_crm_action" style="height: 300px; width: 700px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- footer -->
                        <div class="modal-footer">
                            <div style="text-align: right;">
                                <button type="button" class="btn btn-outline-dark" data-bs-dismiss="modal" aria-label="Close" name="modal_btn_close">閉じる</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ページネーション -->
            <div style="margin: 0 auto;">
                <nav aria-label="Page navigation example">
                    <ul class="pagination mt-4">
                    <li class="page-item"><a class="page-link" href="{% url 'apr:han_list_page_first' %}">最初へ</a></li>
                    <li class="page-item"><a class="page-link" href="{% url 'apr:han_list_page_prev' %}">前へ</a></li>
                    <li class="page-item"><a class="page-link" pointer-events: none;>{{num}}/{{all_num}}</a></li>               
                    <li class="page-item"><a class="page-link" href="{% url 'apr:han_list_page_next' %}">次へ</a></li>
                    <li class="page-item"><a class="page-link" href="{% url 'apr:han_list_page_last' %}">最後へ</a></li> 
                    </ul>
                </nav>
            </div>
        </div>

    </div>


      

    <!-- 各種Ajax -->
    <script>

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i <cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
  
        var csrftoken = getCookie('csrftoken');
  
        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }
  
        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });
  

        // 通常版切れ_選択
        document.getElementById("choice_hangire").addEventListener("click",function(){
            document.getElementById("choice_approach_select").style.display="none";
            $.ajax({
                'url': '{% url "apr:choice_id" %}',
                'type': 'POST',
                'data': {"han_or_apr":"han"},
                'dataType': 'json'
            })
            .done(function(response){
                window.location.reload();
            })
        });


        // 半年版切れ_選択
        document.getElementById("choice_half").addEventListener("click",function(){
            document.getElementById("choice_approach_select").style.display="none";
            $.ajax({
                'url': '{% url "apr:choice_id" %}',
                'type': 'POST',
                'data': {"han_or_apr":"half"},
                'dataType': 'json'
            })
            .done(function(response){
                window.location.reload();
            })
        });


        // 版切れ以外受注_選択
        document.getElementById("choice_igai").addEventListener("click",function(){
            document.getElementById("choice_approach_select").style.display="none";
            $.ajax({
                'url': '{% url "apr:choice_id" %}',
                'type': 'POST',
                'data': {"han_or_apr":"not_han"},
                'dataType': 'json'
            })
            .done(function(response){
                window.location.reload();
            })
        });


        // 納品フォロー_選択
        document.getElementById("choice_nouhin").addEventListener("click",function(){
            document.getElementById("choice_approach_select").style.display="none";
            $.ajax({
                'url': '{% url "apr:choice_id" %}',
                'type': 'POST',
                'data': {"han_or_apr":"nou"},
                'dataType': 'json'
            })
            .done(function(response){
                window.location.reload();
            })
        });


        // 失注_選択
        document.getElementById("choice_lost").addEventListener("click",function(){
            document.getElementById("choice_approach_select").style.display="none";
            $.ajax({
                'url': '{% url "apr:choice_id" %}',
                'type': 'POST',
                'data': {"han_or_apr":"lost"},
                'dataType': 'json'
            })
            .done(function(response){
                window.location.reload();
            })
        });


        // アプローチリスト選択
        document.getElementById("choice_approach").addEventListener("click",function(){
            document.getElementById("choice_approach_select").style.display="";
            $.ajax({
                'url': '{% url "apr:choice_id" %}',
                'type': 'POST',
                'data': {
                    "han_or_apr":"apr",
                    "approach_id":document.getElementById("choice_approach_id").value
                },
                'dataType': 'json'
            })
            .done(function(response){
                window.location.reload();
            })
        });


        // アプローチリスト内容決定
        document.getElementById("choice_approach_id").addEventListener("change",function(){
            $.ajax({
                'url': '{% url "apr:choice_id" %}',
                'type': 'POST',
                'data': {
                    "han_or_apr":"apr",
                    "approach_id":document.getElementById("choice_approach_id").value
                },
                'dataType': 'json'
            })
            .done(function(response){
                window.location.reload();
            })
        });


        // 検索クリアボタン
        document.getElementById("form_clear").addEventListener("click",function(e){
            e.preventDefault();
            document.getElementById("han_busho").value="";
            document.getElementById("han_tantou").value="";
            document.getElementById("han_pref").value="";
            document.getElementById("han_day_st").value="";
            document.getElementById("han_day_ed").value="";
            document.getElementById("han_com").value="";
            document.getElementById("han_sei").value="";
            document.getElementById("han_mei").value="";
            document.getElementById("han_tel").value="";
            document.getElementById("han_mail").value="";

            var rs=document.getElementsByName("han_result");
            for (var i=0; i<rs.length; i++){
                rs[i].checked=false;
            };
        });


        // 部署選択_上部
        document.getElementById("han_busho").addEventListener("change",function(){
            $.ajax({
                'url': '{% url "apr:hangire_busho_up" %}',
                'type': 'POST',
                'data': {"busho_id":this.value},
                'dataType': 'json'
            })
            .done(function(response){
                var tantou_list=response.tantou_up
                var str="<option value=''></option>"
                for (var i=0; i<tantou_list.length; i++){
                    str=str + "<option value='" + tantou_list[i][0] + "'>" + tantou_list[i][1] + "</option>"
                };
                document.getElementById("han_tantou").innerHTML=str;
            })
        });


        // 顧客詳細ボタン
        var item=document.getElementsByName("crm_list");
        for (var i=0; i<item.length; i++){
            item[i].addEventListener("click",function(){
                $.ajax({
                    'url': '{% url "sfa:kokyaku_detail_api" %}',
                    'type': 'POST',
                    'data': {"cus_id":this.childNodes[3].innerText},
                    'dataType': 'json'
                })
                .done(function(response){
                    window.open("{% url 'crm:kokyaku_api' %}", '_blank');
                })
            },false)
        };


        // 詳細モーダル表示
        $("#modal_apr").on("show.bs.modal", function (event) {
            var item=document.getElementsByName("open_modal");
            for (var i=0; i<item.length; i++){
                item[i].addEventListener("click",function(){
                    var clear_color=document.getElementById("clear_color");
                    try{
                        clear_color.parentElement.parentElement.style.backgroundColor="#fff";
                        clear_color.innerHTML="<i class='bi bi-pencil-square'></i>";
                    } catch(e){
                        ;
                    };
                    this.parentElement.parentElement.style.backgroundColor="#e0ffc2";
                    this.innerHTML="<i class='bi bi-caret-up-square-fill'></i>"
                    modal_show_top(this.id);
                    modal_show_bot(this.id);
                    modal_clear();
                },false)
            };
        });


        // モーダル上部_ajax
        function modal_show_top(pk){
            $.ajax({
                'url': '{% url "apr:hangire_modal_show_top" %}',
                'type': 'POST',
                'data': {"pk":pk},
                'dataType': 'json'
            })
            .done(function(response){
                result=response.result[0];
                document.getElementById("modal_pk").innerText=result.id;
                dic={
                    0:["未対応","#000","#fff"],
                    1:["アプローチしない","#000","#959595"],
                    2:["不在","#800080","#eedfff"],
                    3:["検討します","#005b00","#dcffbf"],
                    4:["失注/予定なし","#000","#e2e2e2"],
                    5:["案件化","#0000a0","#b7ffff"],
                    6:["受注","#ff0000","#ffff80"],
                    7:["その他","#000","#ffdddd"]
                };
                document.getElementById("modal_cus_com").innerText=result.cus_com;
                document.getElementById("modal_cus_name").innerText=result.cus_sei + result.cus_mei;
                document.getElementById("modal_top_result").innerText=dic[result.result][0];
                document.getElementById("modal_top_result").style.color=dic[result.result][1];
                document.getElementById("modal_top_result").style.backgroundColor=dic[result.result][2];
                document.getElementById("modal_top_day").innerText=result.apr_day;
                document.getElementById("modal_top_tantou").innerText=result.apr_tantou;

                str=""
                if (result.apr_type == 4){
                    if (result.apr_tel_result == "対応"){
                        str="<span style='color: blue; font-size: 1.2em;'><i class='bi bi-telephone-forward-fill'></i></span>"
                    } else {
                        str="<span style='color: gray; font-size: 1.2em;'><i class='bi bi-telephone-x-fill'></i></span>"
                    };
                } else if (result.apr_type == 2){
                    str="<span style='color: rgb(204, 173, 0); font-size: 1.2em;'><i class='bi bi-envelope-fill'></i></span>"
                } else if (result.apr_type == 1){
                    str="<span style='color: #646565; font-size: 1.2em;'><i class='bi bi-clipboard-fill'></i></span>"
                };
                
                document.getElementById("modal_top_type").innerHTML=str;
                document.getElementById("modal_top_bikou").innerText=result.apr_text;
            })
        }


        // モーダル下部_ajax
        function modal_show_bot(pk){
            $.ajax({
                'url': '{% url "apr:hangire_modal_show_bot" %}',
                'type': 'POST',
                'data': {"pk":pk},
                'dataType': 'json'
            })
            .done(function(response){
                cus_act=response.cus_act;
                var str = "";
                var last_str = "";
                for (var i of cus_act){
                    if (i.kubun == "est"){
                        str="<div class='flex'>" +
                            "<div>" + i.day + "</div>" + 
                            "<div style='margin-left: 10px;'>" + i.est_num + "</div>" +
                            "<div style='margin-left: 10px;'>" + i.status + "</div>" +
                            "<div style='margin-left: 10px;'>" + i.money.toLocaleString() + "円</div>" +
                            "<div style='font-size: 0.9em;''>（" + i.busho + "：" + i.tantou + "）</div>" +
                            "</div>";
                    } else {
                        var icon = "";
                        var text = "";
                        // アイコン
                        if (i.type == 1){
                            icon="<span style='color: #646565; font-weight: bold;'><i class='bi bi-clipboard-fill'></i></span>";
                        } else if (i.type == 2){
                            icon="<span style='color: #ff9900; font-weight: bold;'><i class='bi bi-envelope-fill'></i></span>";
                        } else if (i.type == 3){
                            icon="<span style='color: #ff02f2; font-weight: bold;'><i class='bi bi-envelope-heart-fill'></i></span>";
                        } else if (i.type == 4){
                            if (i.tel_result == "対応"){
                                icon="<span style='color: blue; font-weight: bold;'><i class='bi bi-telephone-forward-fill'></i></span>";
                            } else{
                                icon="<span style='color: gray; font-weight: bold;'><i class='bi bi-telephone-x-fill'></i></span>";
                            };
                        } else if (i.type == 5){
                            icon="<span style='color: #00c2b8; font-weight: bold;'><i class='bi bi-people-fill'></i></span>";
                        } else if (i.type == 6){
                            icon="<span style='color: red; font-weight: bold;'><i class='bi bi-bell-fill'></i></span>";
                        } else if (i.type == 7){
                            icon="<span style='color: #ff3502; font-weight: bold;'><i class='bi bi-shop'></i></span>";
                        } else if (i.type == 8){
                            icon="<span style='color: #b37400; font-weight: bold;'><i class='bi bi-stack'></i></span>";
                        };
                        // テキスト
                        if (i.type == 4){
                            text="【" + i.tel_result + "】 " + i.text;
                        } else {
                            text=i.text;
                        };
                        str="<div class='flex'>" +
                            "<div>" + i.day + "</div>" +
                            "<div style='margin-left: 10px;'>" + icon + "</div>" +
                            "<div style='margin-left: 10px;'>" + text + "</div>" +
                            "</div>";
                    };
                    
                    // カード形式
                    if (i.kubun == "est"){
                        str = "<div class='main0 main1' style='width:100%; cursor:auto'>" + str + "</div>";
                    } else {
                        if (i.type == 3){
                            str = "<div class='main0 main2' style='width:100%; cursor:auto''>" + str + "</div>";
                        } else if (i.type == 8){
                            str = "<div class='main0 main3' style='width:100%; cursor:auto''>" + str + "</div>";
                        } else {
                            str = "<div class='main0 main_all' style='width:100%;' name='act_list' id='" + i.act_id + "'>" + str + "</div>";
                        };
                    };

                    last_str = last_str + str;
                };
                document.getElementById("modal_crm_action").innerHTML=last_str;
                modal_list_click()
            })
        }
        

        // モーダルの表示順
        var mo_sort = document.getElementById("modal_sort");
        mo_sort.addEventListener("change",function(){
            $.ajax({
                'url': '{% url "apr:hangire_modal_sort" %}',
                'type': 'POST',
                'data': {"jun":mo_sort.value},
                'dataType': 'json'
            })
            .done(function(response){
                var pk=document.getElementById("modal_pk").innerText;
                modal_show_bot(pk);
            })
        })


        // モーダル_TELの場合
        var mo_type = document.getElementById("modal_apr_type");
        mo_type.addEventListener("change",function(){
            if (mo_type.value == 4){
                document.getElementById("modal_tel_hyouji").style.display="";
            } else {
                document.getElementById("modal_tel_hyouji").style.display="none";
            };
        });


        // モーダル_クリア
        function modal_clear(){
            var now = new Date()
            document.getElementById("modal_act_id").innerText="";
            document.getElementById("modal_apr_result").value="0";
            document.getElementById("modal_apr_type").value="";
            document.getElementById("modal_apr_tantou").value=document.getElementById("modal_user").innerText;
            document.getElementById("modal_apr_day").value=now.toLocaleDateString('sv-SE');
            document.getElementById("modal_apr_text").value="";
            document.getElementById("modal_apr_tel").value="対応";
            document.getElementById("modal_tel_hyouji").style.display="none";
            document.getElementById("modal_show_A").style.visibility="visible";
        }

        // モーダル_新規
        document.getElementById("modal_btn_apr_new").addEventListener("click",function(){
            modal_clear()
        });


        // モーダル_リストクリック
        function modal_list_click(){
            var item=document.getElementsByName("act_list");
            for (var i=0; i<item.length; i++){
                item[i].addEventListener("click",function(){
                    document.getElementById("modal_act_id").innerText=this.id;
                    $.ajax({
                        'url': '{% url "apr:hangire_modal_list_click" %}',
                        'type': 'POST',
                        'data': {"act_id":this.id},
                        'dataType': 'json'
                    })
                    .done(function(response){
                        res=response.res;
                        if (res.type == 4){
                            document.getElementById("modal_tel_hyouji").style.display="block";
                        } else {
                            document.getElementById("modal_tel_hyouji").style.display="none";
                        };
                        document.getElementById("modal_apr_result").value="";
                        document.getElementById("modal_apr_type").value=res.type;
                        document.getElementById("modal_apr_tel").value=res.tel;
                        document.getElementById("modal_apr_day").value=res.day;
                        document.getElementById("modal_apr_text").value=res.text;
                        document.getElementById("modal_show_A").style.visibility="hidden";
                        document.getElementById("modal_show_B").style.display="";
                        document.getElementById("modal_show_C").style.display="none";
                        document.getElementById("modal_tantou_block").style.display="";
                    })
                },false)
            };
        }


        // モーダル_決定
        document.getElementById("modal_btn_apr_ok").addEventListener("click",function(e){
            pk = document.getElementById("modal_pk").innerText;
            var type = document.getElementById("modal_apr_type").value;
            var day = document.getElementById("modal_apr_day").value;
            var act_id = document.getElementById("modal_act_id").innerText;
            var tantou = document.getElementById("modal_apr_tantou").value;
            var result = document.getElementById("modal_apr_result").value;

            if (type==0){
                window.alert("種類を選択してください！");
                return
            } else if (day==""){
                window.alert("日付を入力してください！");
                return
            } else if (act_id == "" && tantou == ""){
                window.alert("記入者を入力してください！");
                return
            } else if (act_id == "" && result == "0"){
                window.alert("結果は「未対応」以外を選択してください！");
                return
            };
            $.ajax({
                'url': '{% url "apr:hangire_modal_btn" %}',
                'type': 'POST',
                'data': {
                    "pk":pk,
                    "act_id":act_id,
                    "result":document.getElementById("modal_apr_result").value,
                    "tantou":tantou,
                    "day":day,
                    "type":type,
                    "tel_result":document.getElementById("modal_apr_tel").value,
                    "text":document.getElementById("modal_apr_text").value
                },
                'dataType': 'json'
            })
            .done(function(response){
                if (response.result == "ok"){
                    modal_show_top(pk);
                    modal_show_bot(pk);
                    modal_clear();
                } else {
                    window.alert("環境依存文字が含まれているため、保存できません！");
                };
            })
        });


        // モーダル_削除
        document.getElementById("modal_btn_apr_del").addEventListener("click",function(e){
            var act_id = document.getElementById("modal_act_id").innerText;
            if (act_id==""){
                window.alert("削除対象を選択してください！");
                return
            };
            
            var ans =confirm("本当に削除しますか？");
            if (ans == false){
                return
            };
            $.ajax({
                'url': '{% url "apr:hangire_modal_del" %}',
                'type': 'POST',
                'data': {"act_id":act_id},
                'dataType': 'json'
            })
            .done(function(response){
                var pk=document.getElementById("modal_pk").innerText;
                modal_show_bot(pk);
                modal_clear();
            })
        });


        // モーダル_結果削除
        document.getElementById("modal_result_del").addEventListener("click",function(){
            pk=document.getElementById("modal_pk").innerText;
            var ans =confirm("本当に削除しますか？");
            if (ans == false){
                return
            };
            $.ajax({
                'url': '{% url "apr:hangire_modal_result_del" %}',
                'type': 'POST',
                'data': {"pk":pk},
                'dataType': 'json'
            })
            .done(function(response){
                modal_show_top(pk);
            })
        });


        // モーダル_結果のオプション変更
        document.getElementById("modal_apr_result").addEventListener("change",function(){
            if(document.getElementById("modal_apr_result").value == "tran"){
                document.getElementById("modal_show_B").style.display="none";
                document.getElementById("modal_show_C").style.display="";
                document.getElementById("modal_tantou_block").style.display="none";
            } else {
                document.getElementById("modal_show_B").style.display="";
                document.getElementById("modal_show_C").style.display="none";
                document.getElementById("modal_tantou_block").style.display="";
            };
        });


        // モーダル_転送部署_選択
        var busho=document.getElementById("modal_send_busho");
        busho.addEventListener("change",function(){
            $.ajax({
                'url': '{% url "apr:hangire_busho_now" %}',
                'type': 'POST',
                'data': {"busho_id":this.value},
                'dataType': 'json'
            })
            .done(function(response){
                tantou_list=response.tantou_now;
                var str=""
                for (var i=0; i<tantou_list.length; i++){
                    str=str + "<option value='" + tantou_list[i][0] + "'>" + tantou_list[i][1] + "</option>"
                };
                document.getElementById("modal_send_tantou").innerHTML=str;
            })
        })


        // モーダル_他へ転送
        document.getElementById("modal_send_click").addEventListener("click",function(){
            var busho = document.getElementById("modal_send_busho");
            var tantou = document.getElementById("modal_send_tantou");
            if (busho.value == "0"){
                window.alert("転送先の部署を選択してください！");
                return
            };
            $.ajax({
                'url': '{% url "apr:hangire_modal_send" %}',
                'type': 'POST',
                'data': {
                    "pk":document.getElementById("modal_pk").innerText,
                    "busho_id":busho.value,
                    "busho_name":busho.options[busho.selectedIndex].textContent,
                    "tantou_id":tantou.value,
                    "tantou_name":tantou.options[tantou.selectedIndex].textContent,
                },
                'dataType': 'json'
            })
            .done(function(response){
                window.location.reload();
            })
        });


        // モーダル_結果を受注にする
        document.getElementById("modal_result_juchu").addEventListener("click",function(){
            $.ajax({
                'url': '{% url "apr:hangire_modal_result_juchu" %}',
                'type': 'POST',
                'data': {"pk":document.getElementById("modal_pk").innerText},                
                'dataType': 'json'
            })
            .done(function(response){
                window.location.reload();
            })
        });


        // モーダル終了
        btns=document.getElementsByName("modal_btn_close");
        for (var i=0;i<btns.length;i++){
            btns[i].addEventListener("click",function(){
                window.location.reload();
            })
        };
        

        // 前回モーダルの色をクリア
        function clear_color(){
            $.ajax({
                'url': '{% url "apr:hangire_color_clear" %}',
                'type': 'POST',
                'data': {},
                'dataType': 'json'
            })
            .done(function(response){
                window.location.reload();
            })
        };


    </script>

    <!-- モーダル用 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>


</body>
</html>